<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>Title</title>
    <link rel="stylesheet" href="ys/ys.min.css">
    <link rel="stylesheet" href="ys/pageStyle.css">
    <style>
        .box1 {
            position: absolute;
            padding: 10px 15px;
            background-color: rgba(0, 127, 127, 0.447);
            color: #fff;
            border: 1px solid #3cc47c;
        }

        .box2 {
            position: absolute;
            color: #fff;
            background-color: rgba(0, 127, 127, 0.447);
            box-shadow: 0px 0px 12px rgba(0, 255, 255, 0.5);
            border: 1px solid rgba(127, 255, 255, 0.25);

        }

        .box2 .ys-con1 {
            font-weight: bold;
            color: rgba(255, 255, 255, 0.75);
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.95);
        }

        .box2 .ys-con {
            font-weight: bold;
            color: rgba(255, 255, 255, 0.75);
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.95);
            transform: rotateY(180deg);
        }

        .ys-tit-sm1 {
            line-height: 40px;
            font-size: 16px;
            padding-right: 20px;
            transform: rotateY(180deg);
        }

        .ys-tit-sm1 span:first-child {
            border-left: 4px solid #14AE68;
            padding-left: 10px;
            transform: rotateY(180deg);
        }

        .box1 .ys-con {
            font-weight: bold;
            color: rgba(255, 255, 255, 0.75);
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.95);
        }
    </style>
</head>
<body>
<div class="ys-absolute-container" id="box" style="overflow: hidden"></div>
<div class="ys-fix-container" style="bottom: 10px;top:auto">
    <div class="ys-btn ys-btn-sm btn1" onClick="window.location.href='/studiop'">第一人称视角</div>

</div>
</body>

<script src="js/jquery.min.js"></script>
<script src="js/three.js"></script>
<script src="js/OrbitControls.js"></script>
<script src="js/CSS2DRenderer.js"></script>
<script src="js/CSS3DRenderer.js"></script>
<script src="js/ysThree.js"></script>
<script src="js1/loaders/OBJLoader.js"></script>
<script src="js1/loaders/MTLLoader.js"></script>
<script src="js1/loaders/DDSLoader.js"></script>
<script src="js/tween.min.js"></script>
<script src="js1/WebGL.js"></script>
<script src="js1/three_sprite_utils.js"></script>
<script th:inline="javascript">


    const el = document.getElementById('box')

    const app = new YsThree(el, {})

    const camera = app.camera

    camera.position.set(-300, 400, -1300);
    camera.lookAt(new THREE.Vector3(0, 0, 0));
    const renderer = app.renderer
    const scene = app.scene

    //给场景添加天空盒子纹理
    var cubeTextureLoader = new THREE.CubeTextureLoader();
    cubeTextureLoader.setPath('image/');
    var cubeTexture = cubeTextureLoader.load([
        'RT.jpg', 'LF.jpg',
        'UP.jpg', 'DN.jpg',
        'BK.jpg', 'FR.jpg'
    ]);

    scene.background = cubeTexture;


    function initModel() {

// model
        var onProgress = function (xhr) {
            console.log(xhr)
            if (xhr.lengthComputable) {
                var percentComplete = xhr.loaded / xhr.total * 100;
                console.log(Math.round(percentComplete, 2) + '% downloaded');
            }
        };

        var onError = function (xhr) {
        };

        THREE.Loader.Handlers.add(/\.dds$/i, new THREE.DDSLoader());

        var mtlLoader = new THREE.MTLLoader();
        mtlLoader.setPath('models/test/');
        mtlLoader.load('build1.mtl', function (materials) {

            materials.preload();

            var objLoader = new THREE.OBJLoader();
            objLoader.setMaterials(materials);
            objLoader.setPath('models/test/');
            objLoader.load('build1.obj', function (object) {
                object.name = "model1";
                object.position.y = -0.5;
                object.scale.set(0.5, 0.5, 0.5);
                scene.add(object);
            }, onProgress, onError);

        });
        mtlLoader.load('build2.mtl', function (materials) {

            materials.preload();

            var objLoader = new THREE.OBJLoader();
            objLoader.setMaterials(materials);
            objLoader.setPath('models/test/');
            objLoader.load('build2.obj', function (object) {
                object.name = "model2";
                object.position.y = -0.5;
                object.scale.set(0.5, 0.5, 0.5);
                scene.add(object);

            }, onProgress, onError);

        });
        mtlLoader.load('build3.mtl', function (materials) {

            materials.preload();

            var objLoader = new THREE.OBJLoader();
            objLoader.setMaterials(materials);
            objLoader.setPath('models/test/');
            objLoader.load('build3.obj', function (object) {
                object.name = "model3";
                object.position.y = -0.5;
                object.scale.set(0.5, 0.5, 0.5);
                scene.add(object);

            }, onProgress, onError);

        });
        mtlLoader.load('build4.mtl', function (materials) {

            materials.preload();

            var objLoader = new THREE.OBJLoader();
            objLoader.setMaterials(materials);
            objLoader.setPath('models/test/');
            objLoader.load('build4.obj', function (object) {
                object.name = "model4";
                object.position.y = -0.5;
                object.scale.set(0.5, 0.5, 0.5);
                scene.add(object);

            }, onProgress, onError);

        });
        mtlLoader.load('build5.mtl', function (materials) {

            materials.preload();

            var objLoader = new THREE.OBJLoader();
            objLoader.setMaterials(materials);
            objLoader.setPath('models/test/');
            objLoader.load('build5.obj', function (object) {
                object.name = "model5";
                object.position.y = -0.5;
                object.scale.set(0.5, 0.5, 0.5);
                scene.add(object);

            }, onProgress, onError);

        });


    }

    initModel()

    function makeLabelCanvas(baseWidth, size, name) {
        const ctx = document.createElement('canvas').getContext('2d');
        const boderSize = 2;
        const font = `${size}px bold sans-serif`;
        ctx.font = font;
        const textWidth = ctx.measureText(name).width;

        const doubleBorderSize = boderSize * 2;
        const width = baseWidth + doubleBorderSize;
        const height = size + doubleBorderSize;
        ctx.canvas.width = width;
        ctx.canvas.height = height;

        ctx.font = font;
        ctx.textBaseline = 'middle';
        ctx.textAlign = 'center';

        ctx.fillStyle = "rgba(204,204,204,1)";
        ctx.fillRect(0, 0, width, height);

        // scale to fit but don't stretch
        const scaleFactor = Math.min(1, baseWidth / textWidth);
        ctx.translate(width / 2, height / 2);
        ctx.scale(scaleFactor, 1);
        ctx.fillStyle = "black";
        ctx.fillText(name, 0, 0);

        return ctx.canvas;
    }

    var studios = [[${studios}]];

    function addPeople() {
        makePerson(-123, 101, 97, '全景图', 1, 0, 1.5, 2);
    }

    function makePerson(x, y, z, name, id, rx, ry, rz) {
        const canvas = makeLabelCanvas(90, 40, name);//150
        const bodyRadiusTop = .4;
        const bodyRadiusBottom = .2;
        const bodyHeight = 2;
        const bodyRadialSegments = 6;
        const bodyGeometry = new THREE.CylinderGeometry(
            bodyRadiusTop, bodyRadiusBottom, bodyHeight, bodyRadialSegments);

        const headRadius = bodyRadiusTop * 0.8;
        const headLonSegments = 12;
        const headLatSegments = 5;
        const headGeometry = new THREE.SphereGeometry(
            headRadius, headLonSegments, headLatSegments);

        const labelGeometry = new THREE.PlaneGeometry(1, 1);
        const texture = new THREE.CanvasTexture(canvas);
        const labelMaterial = new THREE.MeshBasicMaterial({
            map: texture,
            side: THREE.DoubleSide,
            transparent: true,
        });
        const bodyMaterial = new THREE.MeshPhongMaterial({
            color: "purple",
            flatShading: true,
        });

        const root = new THREE.Object3D();
        root.position.x = x;

        const body = new THREE.Mesh(bodyGeometry, bodyMaterial);

        const head = new THREE.Mesh(headGeometry, bodyMaterial);

        const label = new THREE.Mesh(labelGeometry, labelMaterial);
        label.rotation.x = Math.PI * rx;
        label.rotation.y = Math.PI * ry;
        label.rotation.z = Math.PI * rz;
        root.add(label);
        label.position.x = x;
        label.position.y = y;
        label.position.z = z;

        const labelBaseScale = 0.60;
        label.scale.x = canvas.width * labelBaseScale;
        label.scale.y = canvas.height * labelBaseScale;


        //this.clickObjects.push(root);
        head.name = id;
        body.name = id;

        //scene.add(root);
    }

    addPeople();


    const controls = app.initOrbitControls()
    controls.target = new THREE.Vector3(-200, 0, 0);
    const clock = new THREE.Clock()
    // app.initStatus(Stats)

    renderer.setPixelRatio(window.devicePixelRatio)


    //add light
    /*const directionalLight = new THREE.DirectionalLight( '#fff' )
      directionalLight.position.set( 30, 30, 30 ).normalize()
      scene.add( directionalLight )
      const ambientLight = new THREE.AmbientLight('#fff',0.3) // obj 唯一 id
      scene.add(ambientLight)*/

    const ambientlight = new THREE.AmbientLight(0xffffff); //6688cc
    ambientlight.castShadow = true;
    scene.add(ambientlight);
    const fillLight3 = new THREE.DirectionalLight(0x888888, 2);// 0xff9999
    fillLight3.position.set(0, 700, 0);
    scene.add(fillLight3);
    /*  ***********/
    /******  css2d *********/
    const instance = new app.CssRenderer(THREE.CSS2DRenderer)
    const css2DRenderer = instance.cssRenderer
    // 增加一个
    // instance.add({
    //     parent: scene, //默认 任何一个object3d
    //     cssObject: THREE.CSS2DObject,
    //     name: 'css2d-1', // 唯一 注意是唯一哦
    //     element: `<div class="box1">  这是一个2d文本 1</div>`,
    //     position: [-10,10,10]
    // })
    // // 增加多个
    console.log(studios.length)
    if (studios.length > 0) {
        instance.add(
            {
                name: 'css2d-2',
                cssObject: THREE.CSS2DObject,
                element: `<div class="box1">    <div class="ys-con">
              ` + studios[0].name + `
            </div></div>`,
                position: [0, 200, 40],
                scale: [0.5, 0.5, 0.5]
            })
    }

    if (studios.length > 1) {
        instance.add(
            {
                name: 'css2d-3',
                cssObject: THREE.CSS2DObject,
                element: `<div class="box1">    <div class="ys-con">
             ` + studios[1].name + `
            </div></div>`,
                position: [0, 180, -430], // position: [0, 180, -430]
                scale: [0.5, 0.5, 0.5]
            })
   }
    if (studios.length > 2) {
        instance.add(
            {
                name: 'css2d-4',
                cssObject: THREE.CSS2DObject,
                element: `<div class="box1">   <div class="ys-con">
              ` + studios[2].name + `
            </div></div>`,
                position: [-450, 190, 40],//   position: [-450, 190, 40]
                scale: [0.5, 0.5, 0.5]
            })
    }
    if (studios.length > 3) {
        instance.add(
            {
                name: 'css2d-5',
                cssObject: THREE.CSS2DObject,
                element: `<div class="box1">   <div class="ys-con">
             ` + studios[3].name + `
            </div></div>`,
                position: [-500, 50, -430],//position: [-500, 50, -430]
                scale: [0.5, 0.5, 0.5]
            })
    }



    // // 改
    // instance.update('css2d-1', `<span>这是修改后的文本</span>`)
    //
    // // 查
    // const object = instance.search('css2d-1')
    // console.log(object)
    //
    // // 删
    // instance.remove('css2d-1', scene) // parent

    const instance2 = new app.CssRenderer(THREE.CSS3DRenderer)
    const css3DRenderer = instance2.cssRenderer

    instance2.add({
        parent: scene, //默认 任何一个object3d
        cssObject: THREE.CSS3DObject,
        name: 'css3d-1', // 唯一 注意是唯一哦
        element: `<div class="box2" id="box2">
        <div class="ys-block1">
            <div class="ys-tit-sm1"><span>建筑群</span></div>
            <div class="ys-con">
                请点击建筑群得到介绍</br>
                双击进入建筑内部</br>
                左下角第一人称视角可以观察建筑全貌
            </div>
        </div>
    </div>`,
        scale: [0.5, 0.5, 0.5],
        position: [-250, 90, -600],

    })


    function onMouseClick(event) {
        var raycaster = new THREE.Raycaster();
        var mouse = new THREE.Vector2();
        //通过鼠标点击的位置计算出raycaster所需要的点的位置，以屏幕中心为原点，值的范围为-1到1.

        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        // 通过鼠标点的位置和当前相机的矩阵计算出raycaster
        raycaster.setFromCamera(mouse, camera);
        //找到场景中所有外部模型
        var scensObjs = [];
        scene.children.forEach(child => {
            for (var i = 0; i < child.children.length; i++) {
                var obj = child.children[i];
                scensObjs.push(obj);
            }
        });
        // 获取raycaster直线和所有模型相交的数组集合
        var intersects = raycaster.intersectObjects(scensObjs);

        var intersect = intersects[0];
        if (intersect.object instanceof THREE.Mesh) {
            var obj = intersect.object.parent;
            //把距离加到模型用户数据里面，方便后面排序
            obj.userData.distance = intersect.distance;
            var str = "/room";
            var userId = [[${userId}]];

            str = str + "?userId=" + userId.toString() + "&studioId=";
            if (obj.name == "model1") {
                window.location.href = str + studios[0].studio_id.toString() + "&taskId=-1&videoId=-2&bookId=-1";
                console.log(obj.name)
            }
            if (obj.name == "model4") {
                window.location.href = str + studios[1].studio_id.toString() + "&taskId=-1&videoId=-2&bookId=-1";
                console.log(obj.name)
            }
            if (obj.name == "model2") {
                window.location.href = str + studios[2].studio_id.toString() + "&taskId=-1&videoId=-2&bookId=-1";
                console.log(obj.name)
            }
            if (obj.name == "model3") {
                window.location.href = str + studios[3].studio_id.toString() + "&taskId=-1&videoId=-2&bookId=-1";
                console.log(obj.name)
            }
            if (obj.name == "model11") {
                window.location.href = "/studiop"
                console.log(11);
            }

        }
    }

    function onfirstClick(event) {
        var raycaster = new THREE.Raycaster();
        var mouse = new THREE.Vector2();
        //通过鼠标点击的位置计算出raycaster所需要的点的位置，以屏幕中心为原点，值的范围为-1到1.

        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        // 通过鼠标点的位置和当前相机的矩阵计算出raycaster
        raycaster.setFromCamera(mouse, camera);
        //找到场景中所有外部模型
        var scensObjs = [];
        scene.children.forEach(child => {
            for (var i = 0; i < child.children.length; i++) {
                var obj = child.children[i];
                scensObjs.push(obj);
            }
        });
        // 获取raycaster直线和所有模型相交的数组集合
        var intersects = raycaster.intersectObjects(scensObjs);

        var intersect = intersects[0];
        if (intersect.object instanceof THREE.Mesh) {
            var obj = intersect.object.parent;
            //把距离加到模型用户数据里面，方便后面排序
            obj.userData.distance = intersect.distance;
            if (obj.name == "model1") {
                instance.remove('css2d-11', scene)
                instance.add({
                    name: 'css2d-11',
                    cssObject: THREE.CSS2DObject,
                    element: `<div class="box2" id="box2">
        <div class="ys-block1">
            <div class="ys-tit-sm"><span>` + studios[0].name + `</span></div>
            <div class="ys-con1">` + studios[0].content + `
            </div>
        </div>
    </div>`,
                    position: [400, 50, -430],
                    scale: [0.5, 0.5, 0.5],
                })
            }
            if (obj.name == "model4") {
                // 删
                instance.remove('css2d-11', scene) // parent
                instance.add({
                    name: 'css2d-11',
                    cssObject: THREE.CSS2DObject,
                    element: `<div class="box2" id="box2">
        <div class="ys-block1">
            <div class="ys-tit-sm"><span>` + studios[1].name + `</span></div>
            <div class="ys-con1">` + studios[1].content + `
            </div>
        </div>
    </div>`,
                    position: [400, 50, -430],
                    scale: [0.5, 0.5, 0.5],
                })
            }
            if (obj.name == "model2") {
                instance.remove('css2d-11', scene)
                instance.add({
                    name: 'css2d-11',
                    cssObject: THREE.CSS2DObject,
                    element: `<div class="box2" id="box2">
        <div class="ys-block1">
            <div class="ys-tit-sm"><span>` + studios[2].name + `</span></div>
            <div class="ys-con1">` + studios[2].content + `
            </div>
        </div>
    </div>`,
                    position: [400, 50, -430],
                    scale: [0.5, 0.5, 0.5],
                })
            }
            if (obj.name == "model3") {
                instance.remove('css2d-11', scene)
                instance.add({
                    name: 'css2d-11',
                    cssObject: THREE.CSS2DObject,
                    element: `<div class="box2" id="box2">
        <div class="ys-block1">
            <div class="ys-tit-sm"><span>` + studios[3].name + `</span></div>
            <div class="ys-con1">` + studios[3].content + `
            </div>
        </div>
    </div>`,
                    position: [400, 50, -430],
                    scale: [0.5, 0.5, 0.5],
                })
            }
        }
    }

    const option = {
        position: [100, 100, -100],//新的位置
        controls: [1, 1, 100], //控制器新的中心点位置(围绕词典旋转等)
        duration: 5000,
        start: function () {
            console.log("开始了");
        },
        update: function () {
            console.log("飞行中");
        },
        done: function () {
            console.log("结束了");
        },
        stop: function () {
            console.log("停止了");
        }
    }
    //app.flyTo (TWEEN,controls,option)
    window.addEventListener('dblclick', onMouseClick, false);
    window.addEventListener('click', onfirstClick, false);

    $(window).resize(function () {
        css2DRenderer.setSize(el.offsetWidth, el.offsetHeight)
        css3DRenderer.setSize(el.offsetWidth, el.offsetHeight)

    })
    /*  ***********/
    controls.autoRotate = false
    app.render(() => {
        TWEEN.update()
        controls.update(clock.getDelta())
        renderer.render(scene, camera)
        css2DRenderer.render(scene, camera)
        css3DRenderer.render(scene, camera)
    })


</script>
</html>

